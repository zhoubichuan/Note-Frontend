# 1.javascript 中的垃圾收集

* 程序的运行需要内存，只要程序要求，操作系统就必须提供内存
* javascript 使用自动内存管理，这被称为"垃圾回收机制"
* 优点是可以简化开发、节省代码
* 缺点是无法完整的掌握内存的分配与回收的具体过程

## 1.1NodeJS 中的内存管理

* 网页端的内存泄漏
* 对于持续运行的服务进程 Node 服务器端程序，必须及时释放不再用到的内存。否则，内存占用越来越高，轻则影响系统性能，重则导致进程崩溃。
* 如果不再用到内存没有及时释放，就叫做内存泄漏

## 1.2 v8 内存管理

### 1.2.1 v8 内存限制

* 在 64 位操作系统可以使用 1.4G 内存
* 在 32 位操作系统可以使用 0.7G 内存

### 1.2.2 v8 内存管理

* js 对象都是通过 v8 进行分配管理内存的
* process.memoryUsage 返回一个对象，包含了 Node 进程的内存占用信息

![](./node_memory.png)

* rss(resident set size):所有内存占用，包括指令区和堆栈

- heap Tatal:"堆"占用的内存，包括用到的和没用到的
- heapUsed：用到的堆的部分。判断内存泄漏，以 headUsed 字段为准

- external:V8 引擎内部的 C++对象占用的内存
  ![](./2.png)

## 为何限制内存大小

#### 因为 V8 垃圾收集工作原理导致的，1.4G 内存完成一次垃圾收集需要 1 秒以上

#### 这个暂停时间成为 Stop The Word，在这个期间，应用性能和响应能力都会下降

## 如何打开内存限制

### 一旦初始化成功，生效后不能再修改

### -max-new-space-size,最大 new space 大小，执行 scavenge 回收，默认 16M，单位 KB

```
node --max-old-space-size=2000 app.js 单位是M
```

### -max-old-space-size，最大 old sapce 大小，执行 MarkSweep 回收，默认 1G，单位 MB

```
node --max-new-space-size=1024 app.js单位是kb
```

## V8 的垃圾回收机制

### V8 是基于分代的垃圾回收

### 不同代垃圾回收机制也不一样

### 按存货的时间分为新生代和老生代

## 分代

### 年龄小的是新生代，由 From 区域和 To 区域两个区域组成
